apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: magflow-ingress
  annotations:
    # Use the nginx ingress controller
    kubernetes.io/ingress.class: nginx
    
    # Enable CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "PUT, GET, POST, OPTIONS, DELETE"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    
    # SSL/TLS settings
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: 20m
    
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-rpm: "1000"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    
    # Enable gzip compression
    nginx.ingress.kubernetes.io/enable-rewrite-log: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      gzip on;
      gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
      gzip_min_length 1000;
      gzip_proxied any;
      gzip_comp_level 6;
      gzip_buffers 16 8k;
      gzip_http_version 1.1;
      gzip_vary on;
      gzip_disable "msie6";
      
      # Enable HTTP/2
      listen 443 ssl http2;
      
      # Security headers
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "no-referrer-when-downgrade" always;
      add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
      
      # Disable server tokens
      server_tokens off;
      
      # Enable HSTS
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      
      # Enable CSP
      add_header Content-Security-Policy "default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        font-src 'self';
        connect-src 'self';
        media-src 'self';
        object-src 'none';
        frame-ancestors 'none';
        form-action 'self';
        base-uri 'self';
        block-all-mixed-content;
        upgrade-insecure-requests;" always;

tls:
- hosts:
  - api.magflow.example.com
  secretName: magflow-tls-secret

spec:
  rules:
  - host: api.magflow.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: magflow-service
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: magflow-service
            port:
              number: 80
      - path: /docs
        pathType: Prefix
        backend:
          service:
            name: magflow-service
            port:
              number: 80
      - path: /redoc
        pathType: Prefix
        backend:
          service:
            name: magflow-service
            port:
              number: 80
      - path: /metrics
        pathType: Prefix
        backend:
          service:
            name: magflow-service
            port:
              number: 8010
